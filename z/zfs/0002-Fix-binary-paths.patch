From 335a9da7010bc8f1f14b24aaae4e629d7cad9296 Mon Sep 17 00:00:00 2001
From: "William A. Kennington III" <wak@google.com>
Date: Wed, 19 Oct 2016 18:33:20 -0700
Subject: [PATCH 2/2] Fix binary paths

---
 cmd/ztest/ztest.c                       | 6 +++---
 etc/systemd/system/zfs-share.service.in | 2 +-
 lib/libzfs/libzfs_mount.c               | 4 ++--
 module/Makefile.in                      | 2 +-
 4 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/cmd/ztest/ztest.c b/cmd/ztest/ztest.c
index 2e4dae3..89a19f0 100644
--- a/cmd/ztest/ztest.c
+++ b/cmd/ztest/ztest.c
@@ -790,14 +790,14 @@ process_options(int argc, char **argv)
 		 * We want to extract <isa> to determine if we should use
 		 * 32 or 64 bit binaries.
 		 */
-		bin = strstr(cmd, "/usr/bin/");
+		bin = strstr(cmd, "/run/current-system/sw/bin/");
 		ztest = strstr(bin, "/ztest");
 		isa = bin + 9;
 		isalen = ztest - isa;
 		(void) snprintf(zo->zo_alt_ztest, sizeof (zo->zo_alt_ztest),
-		    "%s/usr/bin/%.*s/ztest", realaltdir, isalen, isa);
+		    "%s/run/current-system/sw/bin/%.*s/ztest", realaltdir, isalen, isa);
 		(void) snprintf(zo->zo_alt_libpath, sizeof (zo->zo_alt_libpath),
-		    "%s/usr/lib/%.*s", realaltdir, isalen, isa);
+		    "%s/run/current-system/sw/lib/%.*s", realaltdir, isalen, isa);
 
 		if (0 != access(zo->zo_alt_ztest, X_OK)) {
 			ztest_dump_core = B_FALSE;
diff --git a/etc/systemd/system/zfs-share.service.in b/etc/systemd/system/zfs-share.service.in
index 688731e..cd0efc7 100644
--- a/etc/systemd/system/zfs-share.service.in
+++ b/etc/systemd/system/zfs-share.service.in
@@ -9,7 +9,7 @@ PartOf=smb.service
 [Service]
 Type=oneshot
 RemainAfterExit=yes
-ExecStartPre=-@bindir@/rm -f /etc/dfs/sharetab
+ExecStartPre=-/run/current-system/sw/bin/rm -f /etc/dfs/sharetab
 ExecStart=@sbindir@/zfs share -a
 
 [Install]
diff --git a/lib/libzfs/libzfs_mount.c b/lib/libzfs/libzfs_mount.c
index 4478167..93f6a12 100644
--- a/lib/libzfs/libzfs_mount.c
+++ b/lib/libzfs/libzfs_mount.c
@@ -278,7 +278,7 @@ static int
 do_mount(const char *src, const char *mntpt, char *opts)
 {
 	char *argv[8] = {
-	    "/bin/mount",
+	    "/run/current-system/sw/bin/mount",
 	    "-t", MNTTYPE_ZFS,
 	    "-o", opts,
 	    (char *)src,
@@ -314,7 +314,7 @@ do_unmount(const char *mntpt, int flags)
 	char force_opt[] = "-f";
 	char lazy_opt[] = "-l";
 	char *argv[7] = {
-	    "/bin/umount",
+	    "/run/current-system/sw/bin/umount",
 	    "-t", MNTTYPE_ZFS,
 	    NULL, NULL, NULL, NULL };
 	int rc, count = 3;
diff --git a/module/Makefile.in b/module/Makefile.in
index 8d02f57..5d5546e 100644
--- a/module/Makefile.in
+++ b/module/Makefile.in
@@ -73,7 +73,7 @@ modules_uninstall:
 distdir:
 	list='$(subdir-m)'; for subdir in $$list; do \
 		(cd @top_srcdir@/module && find $$subdir -name '*.c' -o -name '*.h' -o -name '*.S' |\
-		xargs /bin/cp --parents -t $$distdir); \
+		xargs cp --parents -t $$distdir); \
 	done
 
 distclean maintainer-clean: clean
-- 
2.8.0.rc3.226.g39d4020

